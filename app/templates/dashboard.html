{% extends "base.html" %}

{% block content %}
<style>
    #delete-link {
        background-color: #e3342f;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    #delete-link:hover {
        background-color: #cc1f1a;
    }
</style>
    <h1>Dashboard</h1>
    <h2>Welcome, {{ user.username }}!</h2>
    <p><strong>Account Type:</strong> <span style="text-transform: capitalize;">{{ user.account_type }}</span></p>

    {% if show_form %}
    <div class="form-container" style="max-width: none; margin: 2rem 0;">
        <h3>Add a new link</h3>
        <form action="" method="post" novalidate>
            {{ form.hidden_tag() }}
            <div class="form-group">
                {{ form.title.label }}
                {{ form.title(class="form-control") }}
                {% for error in form.title.errors %}
                <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </div>
            <div class="form-group">
                {{ form.url.label }}
                {{ form.url(class="form-control") }}
                {% for error in form.url.errors %}
                <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </div>
            <div class="form-group">
                {{ form.submit(class="btn") }}
            </div>
        </form>
    </div>
    {% else %}
    <h3>Add a new link</h3>
    <p>You have reached the maximum of 2 links for a free account. Please <a href="{{ url_for('main.pricing') }}">upgrade</a> to add more.</p>
    {% endif %}

    <h3>Your links</h3>
    <p>Total clicks: {{ total_clicks }}</p>
    {% for link in links %}
        <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
            <span>{{ link.title }}: {{ link.url }} (Clicks: {{ link.clicks.count() }})</span>
            <form action="{{ url_for('main.delete_link', link_id=link.id) }}" method="post" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input id="delete-link" type="submit" value="Delete" onclick="return confirm('Are you sure you want to delete this link?');">
            </form>
        </div>
    {% else %}
        <p>You haven't added any links yet.</p>
    {% endfor %}

    {% if current_user.account_type != 'Free' %}
    <hr>
    <h3>Advanced Analytics</h3>
    <table border="1" style="width:100%; border-collapse: collapse;">
        <thead>
            <tr>
                <th style="padding: 8px;">Link</th>
                <th style="padding: 8px;">Time</th>
                <th style="padding: 8px;">IP Address</th>
                <th style="padding: 8px;">User Agent</th>
                <th style="padding: 8px;">Referrer</th>
            </tr>
        </thead>
        <tbody>
            {% for link in links %}
                {% for click in link.clicks %}
                    <tr>
                        <td style="padding: 8px;">{{ link.title }}</td>
                        <td style="padding: 8px;">{{ click.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td style="padding: 8px;">{{ click.ip_address }}</td>
                        <td style="padding: 8px;">{{ click.user_agent }}</td>
                        <td style="padding: 8px;">{{ click.referrer or 'N/A' }}</td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 8px;">No clicks yet.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
{% endblock %}